<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>104.3 MYFM</title>

<style>
body {
    margin:0;
    background:#111;
    color:white;
    font-family:-apple-system, sans-serif;
    text-align:center;
}

.container {
    max-width:420px;
    margin:auto;
    padding:20px;
}

#overlay {
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    z-index:1000;
}

#overlay button {
    font-size:22px;
    padding:15px 30px;
    border-radius:40px;
    border:none;
    background:#ff3b30;
    color:white;
}

img#cover {
    width:100%;
    border-radius:20px;
    margin-top:15px;
}

audio {
    width:100%;
    margin-top:15px;
}

.history {
    margin-top:30px;
    text-align:left;
}

.history h4 {
    font-size:14px;
    color:#aaa;
}

.history-item {
    display:flex;
    align-items:center;
    margin-bottom:12px;
}

.history-item img {
    width:50px;
    height:50px;
    border-radius:8px;
    margin-right:10px;
    object-fit:cover;
}

.song-info { overflow:hidden; }

.song-title {
    font-size:14px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}

.song-artist {
    font-size:12px;
    color:#888;
}
</style>
</head>

<body>

<div id="overlay">
    <h2>ðŸŽµ 104.3 MYFM</h2>
    <button onclick="startPlayback()">Tap to Play</button>
</div>

<div class="container">

<img id="cover">
<h3 id="title">Loading...</h3>
<p id="artist"></p>

<audio id="radio" controls>
<source src="https://stream.revma.ihrhls.com/zc173/hls.m3u8" type="application/x-mpegURL">
</audio>

<div class="history">
    <h4>RECENTLY PLAYED</h4>
    <div id="historyList"></div>
</div>

</div>

<script>

const API_URL =
"https://webapi.radioedit.iheart.com/graphql?operationName=GetCurrentlyPlayingSongs&variables=%7B%22slug%22%3A%22kbig-fm%22%2C%22paging%22%3A%7B%22take%22%3A6%7D%7D&extensions=%7B%22persistedQuery%22%3A%7B%22version%22%3A1%2C%22sha256Hash%22%3A%22386763c17145056713327cddec890cd9d4fea7558efc56d09b7cd4167eef6060%22%7D%7D";

let lastTrackId = "";
let hasUserInteracted = false;

const audio = document.getElementById("radio");

function startPlayback() {
    audio.play().then(() => {
        hasUserInteracted = true;
        document.getElementById("overlay").style.display = "none";
    }).catch(() => {
        console.log("Autoplay blocked");
    });
}

// ìƒˆë¡œê³ ì¹¨ ì‹œ ìžë™ ìž¬ìƒ ì‹œë„
window.addEventListener("load", () => {
    audio.play().then(() => {
        document.getElementById("overlay").style.display = "none";
    }).catch(() => {
        document.getElementById("overlay").style.display = "flex";
    });
});

async function fetchTrack() {
    try {
        const res = await fetch(API_URL + "&t=" + Date.now());
        const json = await res.json();

        const tracks = json.data.sites.find.stream.amp.currentlyPlaying.tracks;
        if (!tracks || tracks.length === 0) return;

        const current = tracks[0];
        const currentId = current.title + current.artist.artistName;

        if (currentId !== lastTrackId) {
            lastTrackId = currentId;
            updateCurrent(current);
            updateHistory(tracks.slice(1,6));
        }

    } catch(e) {
        console.log("API error", e);
    }
}

function updateCurrent(track) {
    document.getElementById("title").innerText = track.title;
    document.getElementById("artist").innerText = track.artist.artistName;

    let img = (track.imagePath || "").replace("http://","https://");
    document.getElementById("cover").src = img;

    // ìž ê¸ˆí™”ë©´ ë©”íƒ€ë°ì´í„° ì§€ì›
    if ("mediaSession" in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: track.title,
            artist: track.artist.artistName,
            album: "104.3 MYFM",
            artwork: [{ src: img, sizes: "512x512", type: "image/jpeg" }]
        });
    }
}

function updateHistory(historyTracks) {
    const list = document.getElementById("historyList");
    list.innerHTML = "";

    historyTracks.forEach(track => {
        let img = (track.imagePath || "").replace("http://","https://");

        const item = document.createElement("div");
        item.className = "history-item";

        item.innerHTML = `
            <img src="${img}">
            <div class="song-info">
                <div class="song-title">${track.title}</div>
                <div class="song-artist">${track.artist.artistName}</div>
            </div>
        `;

        list.appendChild(item);
    });
}

fetchTrack();
setInterval(fetchTrack, 10000);

</script>

</body>
</html>
